<?php

/*
* Get the author name from the path alias.
*/

function getName($which) {
  $pageAlias = drupal_get_path_alias();
  $pieces1 = explode("/", $pageAlias);
  $pieces2 = explode("-", $pieces1[1]);

  if ($which == 'last') {
    return ucfirst($pieces2[1]);
  }
  elseif ($which == 'first') {
    return ucfirst($pieces2[0]);
  }
}

/*
* Convert the json and loop through the array to 
* find titles by the author.
*/

function grabTitles() {
  $pubListSrc = "sites/all/modules/custom/wri_external_pub_list/wriauthors.json";
  $pubList = file_get_contents($pubListSrc);
  $pubListArray = json_decode($pubList, true);

  $authLast = getName('last');
  $authFirst = getName('first');

  foreach($pubListArray as $key => $publication_entry) {
    if ($publication_entry['author']) {
      foreach ($publication_entry['author'] as $author) {
        $first_name = $author['given'];
	$last_name = $author['family'];
        if ($first_name == $authFirst && $last_name == $authLast) {
          $author_publications_array[] = "<p>" . $authLast . ", " . $authFirst . ". \"" . $publication_entry['title'] . ".\" <em>" . $publication_entry['container-title'] . "</em> " . $publication_entry['volume'] . " (" . $publication_entry['issued']['date-parts'][0][0] . "): " . $publication_entry['page'] . ". doi:" . $publication_entry['DOI'] . ".</p>";
	}
      }
    }
  }

  if ($author_publications_array) {
    $matches = implode('', $author_publications_array);
  }
  else {
    $matches = "<p>No external publications listed for: " . $authFirst . " " . $authLast . "</p><style>.pane-wri-external-pub-list-external-publications { display: none !important; } #content .nav--tabs .nav-item:last-child { display: none !important; }</style>";
  }
  return $matches;
}

/** 
* Create the Drupal blocks. 
*/

/**
* Implement hook_block_info().
*/

function wri_external_pub_list_block_info() {
  $blocks = array();
  $blocks['external_publications'] = array(
    'info' => t('External Publications'),
  );
  return $blocks;
}

/**
* Implement hook_block_view().
*/

function wri_external_pub_list_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'external_publications':
      $block['subject'] = t('List of external publications for author pages');
      $block['title'] = t('External Publications');
      $block['content'] = grabTitles();
      break;
    }
  return $block;
}
